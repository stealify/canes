import{a as process$1}from"./chunk-bacf0c54.mjs";import{a as commonjsGlobal,b as commonjsRequire,c as unwrapExports,d as createCommonjsModule}from"./chunk-eae5b219.mjs";import{a as connect}from"./chunk-52b41786.mjs";import{a as sortedSetJSON}from"./chunk-6f2a5c16.mjs";import{a as require$$0,b as WeakReferenceMap}from"./chunk-4c04edbb.mjs";import"./chunk-5f1245ff.mjs";import{a as canReflect}from"./chunk-7e0220de.mjs";import"./chunk-f8a6947c.mjs";import{a as mapEventBindings}from"./chunk-910f3205.mjs";import{a as dev}from"./chunk-585d4076.mjs";import{a as canSymbol}from"./chunk-b37d91a1.mjs";var callbacksOnce=createCommonjsModule(function(e){var t=[].forEach,n=["createdInstance","updatedInstance","destroyedInstance"],s=connect.behavior("constructor/callbacks-once",function(e){var s={};return t.call(n,function(t){s[t]=function(n,s){var i=this.getInstanceMetaData(n,"last-data-"+t),a=sortedSetJSON(s);if(i!==a){var r=e[t].apply(this,arguments);return this.addInstanceMetaData(n,"last-data-"+t,a),r}}}),s});if(e.exports=s,"production"!==process$1.env.NODE_ENV){var i=require$$0;e.exports=i(s,n)}}),assign=canReflect.assignMap,WeakReferenceSet=function(){this.set=[]};assign(WeakReferenceSet.prototype,{has:function(e){return-1!==this._getIndex(e)},addReference:function(e,t){var n=this._getIndex(e),s=this.set[n];s||(s={item:e,referenceCount:0},this.set.push(s)),s.referenceCount+=t||1},deleteReference:function(e){var t=this._getIndex(e),n=this.set[t];n&&(n.referenceCount--,0===n.referenceCount&&this.set.splice(t,1))},delete:function(e){var t=this._getIndex(e);-1!==t&&this.set.splice(t,1)},get:function(e){var t=this.set[this._getIndex(e)];if(t)return t.item},referenceCount:function(e){var t=this.set[this._getIndex(e)];if(t)return t.referenceCount},_getIndex:function(e){var t;return this.set.every(function(n,s){if(n.item===e)return t=s,!1}),void 0!==t?t:-1},forEach:function(e){return this.set.forEach(e)}});var weakReferenceSet=WeakReferenceSet,store=createCommonjsModule(function(e){var t=0,n=null,s={increment:function(e){t++,clearTimeout(n)},decrement:function(i){0===--t&&(n=setTimeout(function(){s.dispatch("end")},e.exports.requestCleanupDelay)),t<0&&(t=0)},count:function(){return t}};mapEventBindings(s);var i=connect.behavior("constructor/store",function(e){return{instanceStore:new WeakReferenceMap,newInstanceStore:new weakReferenceSet,listStore:new WeakReferenceMap,init:function(){e.init&&e.init.apply(this,arguments),this.hasOwnProperty("_requestInstances")||(this._requestInstances={}),this.hasOwnProperty("_requestLists")||(this._requestLists={}),s.on("end",function(){var e;for(e in this._requestInstances)this.instanceStore.deleteReference(e);for(e in this._requestInstances={},this._requestLists)this.listStore.deleteReference(e),this._requestLists[e].forEach(this.deleteInstanceReference.bind(this));this._requestLists={}}.bind(this))},_finishedRequest:function(){s.decrement(this)},addInstanceReference:function(e,t){var n=t||this.id(e);void 0===n?this.newInstanceStore.addReference(e):this.instanceStore.addReference(n,e)},createdInstance:function(t,n){e.createdInstance.apply(this,arguments),this.moveCreatedInstanceToInstanceStore(t)},moveCreatedInstanceToInstanceStore:function(e){var t=this.id(e);if(this.newInstanceStore.has(e)&&void 0!==t){var n=this.newInstanceStore.referenceCount(e);this.newInstanceStore.delete(e),this.instanceStore.addReference(t,e,n)}},addInstanceMetaData:function(e,t,n){var s=this.instanceStore.set[this.id(e)];s&&(s[t]=n)},getInstanceMetaData:function(e,t){var n=this.instanceStore.set[this.id(e)];if(n)return n[t]},deleteInstanceMetaData:function(e,t){delete this.instanceStore.set[this.id(e)][t]},deleteInstanceReference:function(e){void 0===this.id(e)?this.newInstanceStore.deleteReference(e):this.instanceStore.deleteReference(this.id(e),e)},addListReference:function(e,t){var n=sortedSetJSON(t||this.listQuery(e));n&&(this.listStore.addReference(n,e),e.forEach(function(e){this.addInstanceReference(e)}.bind(this)))},deleteListReference:function(e,t){var n=sortedSetJSON(t||this.listQuery(e));n&&(this.listStore.deleteReference(n,e),e.forEach(this.deleteInstanceReference.bind(this)))},hydratedInstance:function(e){if(s.count()>0){var t=this.id(e);this._requestInstances[t]||(this.addInstanceReference(e),this._requestInstances[t]=e)}},hydrateInstance:function(t){var n=this.id(t);if((n||0===n)&&this.instanceStore.has(n)){var s=this.instanceStore.get(n);return this.updatedInstance(s,t),s}var i=e.hydrateInstance.call(this,t);return this.hydratedInstance(i),i},hydratedList:function(e,t){if(s.count()>0){var n=sortedSetJSON(t||this.listQuery(e));n&&(this._requestLists[n]||(this.addListReference(e,t),this._requestLists[n]=e))}},hydrateList:function(t,n){n=n||this.listQuery(t);var s=sortedSetJSON(n);if(s&&this.listStore.has(s)){var i=this.listStore.get(s);return this.updatedList(i,t,n),i}var a=e.hydrateList.call(this,t,n);return this.hydratedList(a,n),a},getList:function(t){var n=this;s.increment(this);var i=e.getList.call(this,t);return i.then(function(e){n._finishedRequest()},function(){n._finishedRequest()}),i},get:function(t){var n=this;s.increment(this);var i=e.get.call(this,t);return i.then(function(e){n._finishedRequest()},function(){n._finishedRequest()}),i},save:function(t){var n=this;s.increment(this);var i=!this.isNew(t);i&&this.addInstanceReference(t);var a=e.save.call(this,t);return a.then(function(e){i&&n.deleteInstanceReference(t),n._finishedRequest()},function(){n._finishedRequest()}),a},destroy:function(t){var n=this;this.addInstanceReference(t),s.increment(this);var i=e.destroy.call(this,t);return i.then(function(e){n._finishedRequest(),n.deleteInstanceReference(e)},function(){n._finishedRequest()}),i},updatedList:function(t,n,s){var i=t.slice(0);n.data||"number"!=typeof n.length||(n={data:n}),e.updatedList?(e.updatedList.call(this,t,n,s),t.forEach(function(e){this.addInstanceReference(e)}.bind(this))):n.data&&n.data.forEach(function(e){this.addInstanceReference(e)}.bind(this)),i.forEach(this.deleteInstanceReference.bind(this))}}});if(i.requests=s,i.requestCleanupDelay=10,e.exports=i,"production"!==process$1.env.NODE_ENV){var a=require$$0;e.exports=a(i,["hydrateInstance","hydrateList","getList","get","save","destroy"])}}),callbacks=createCommonjsModule(function(e){var t=canReflect.each,n={getListData:"gotListData",createData:"createdData",updateData:"updatedData",destroyData:"destroyedData"},s=connect.behavior("data/callbacks",function(e){var s={};return t(n,function(t,n){s[n]=function(s,i){var a=this;return e[n].call(this,s).then(function(e){return a[t]?a[t].call(a,e,s,i):e})}}),s});if(e.exports=s,"production"!==process$1.env.NODE_ENV){var i=require$$0;e.exports=i(s,["getListData","createData","updateData","destroyData"])}}),indexByIdentity=function(e,t,n){var s=canReflect.size(e);if(!n&&s>0&&(n=canReflect.getSchema(e[0])),n||(n=canReflect.getSchema(t)),!n)throw new Error("No schema to use to get identity.");for(var i=canReflect.getIdentity(t,n),a=0;a<s;a++){if(i===canReflect.getIdentity(e[a],n))return a}return-1},spliceSymbol=canSymbol.for("can.splice");function updateList(e,t,n,s){-1===n?-1!==s&&canReflect.splice(e,s,0,[t()]):-1===s?canReflect.splice(e,n,1,[]):s!==n&&(n<s?(canReflect.splice(e,s,0,[t()]),canReflect.splice(e,n,1,[])):(canReflect.splice(e,n,1,[]),canReflect.splice(e,s,0,[t()])))}function updateListWithItem(e,t,n,s,i,a){if(-1===n||s!==n+1&&s!==n)if(void 0!==e[spliceSymbol])updateList(e,function(){return i.hydrateInstance(t)},n,s);else{var r=i.serializeList(e);updateList(r,function(){return t},n,s),i.updatedList(e,{data:r},a)}}var realTime=connect.behavior("real-time",function(e){var t,n=Promise.resolve();return t={createData:function(){var t=e.createData.apply(this,arguments),s=t.catch(function(){return""});return n=Promise.all([n,s]),t},createInstance:function(e){var t=this;return new Promise(function(s,i){n.then(function(){setTimeout(function(){var n,i=t.id(e),a=t.instanceStore.get(i);a?s(t.updateInstance(e)):(a=t.hydrateInstance(e),n=t.serializeInstance(a),t.addInstanceReference(a),Promise.resolve(t.createdData(e,n)).then(function(){t.deleteInstanceReference(a),s(a)}))},1)})})},createdData:function(e,t,n){var s;s=void 0!==n?this.cidStore.get(n):this.instanceStore.get(this.id(e)),this.addInstanceReference(s,this.id(e)),this.createdInstance(s,e),create.call(this,this.serializeInstance(s)),this.deleteInstanceReference(s)},updatedData:function(e,t){var n=this.instanceStore.get(this.id(t));this.updatedInstance(n,e),update.call(this,this.serializeInstance(n))},updateInstance:function(e){var t=this.id(e),n=this.instanceStore.get(t);n||(n=this.hydrateInstance(e)),this.addInstanceReference(n);var s=this.serializeInstance(n),i=this;return Promise.resolve(this.updatedData(e,s)).then(function(){return i.deleteInstanceReference(n),n})},destroyedData:function(e,t){var n=this.id(t||e),s=this.instanceStore.get(n);s||(s=this.hydrateInstance(e));var i=this.serializeInstance(s);this.destroyedInstance(s,e),destroy.call(this,i)},destroyInstance:function(e){var t=this.id(e),n=this.instanceStore.get(t);n||(n=this.hydrateInstance(e)),this.addInstanceReference(n);var s=this.serializeInstance(n),i=this;return Promise.resolve(this.destroyedData(e,s)).then(function(){return i.deleteInstanceReference(n),n})}},"production"!==process$1.env.NODE_ENV&&(t.gotListData=function(e,t){if(this.queryLogic){Array.isArray(e)&&(e={data:e});for(var n,s=0,i=e.data.length;s<i;s++)if(n=e.data[s],!this.queryLogic.isMember(t,n)){var a="One or more items were retrieved which do not match the 'Set' parameters used to load them. Read the docs for more information: https://canjs.com/doc/can-query-logic.html#TestingyourQueryLogic\n\nBelow are the 'query' parameters:\n"+dev.stringify(t)+"\n\nAnd below is an item which does not match those parameters:\n"+dev.stringify(n);dev.warn(a);break}}return Promise.resolve(e)}),t}),create=function(e){var t=this;this.listStore.forEach(function(n,s){var i=JSON.parse(s),a=indexByIdentity(n,e,t.queryLogic.schema);if(t.queryLogic.isMember(i,e)){var r=t.queryLogic.index(i,n,e);updateListWithItem(n,e,a,r,t,i)}})},update=function(e){var t=this;this.listStore.forEach(function(n,s){var i=JSON.parse(s),a=indexByIdentity(n,e,t.queryLogic.schema);if(t.queryLogic.isMember(i,e)){var r=t.queryLogic.index(i,n,e);updateListWithItem(n,e,a,r,t,i)}else-1!==a&&updateListWithItem(n,e,a,-1,t,i)})},destroy=function(e){var t=this;this.listStore.forEach(function(n,s){var i=JSON.parse(s),a=indexByIdentity(n,e,t.queryLogic.schema);-1!==a&&updateListWithItem(n,e,a,-1,t,i)})};export{store as a,callbacks as b,realTime as c,callbacksOnce as d};
//# sourceMappingURL=chunk-3b983740.js.map
