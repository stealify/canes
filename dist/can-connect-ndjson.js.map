{"version":3,"file":"can-connect-ndjson.js","sources":["../node_modules/can-connect-ndjson/can-connect-ndjson.js"],"sourcesContent":["/* global ReadableStream */\n/* exported connectNdjson */\nvar connect = require(\"can-connect\");\nvar sortedSetJSON = require(\"can-connect/helpers/sorted-set-json\");\nvar ndJSONStream = require(\"can-ndjson-stream\");\nvar canReflect = require(\"can-reflect\");\nvar namespace = require('can-namespace');\n\nvar connectNdjson = connect.behavior(\"data-ndjson\", function(baseConnection) {\n  //Feature detection and fallback if ReadableStream and fetch are not supported\n  try {\n    new ReadableStream();\n\t\tif(typeof window.fetch !== \"function\") {\n\t\t\tthrow new Error(\"fetch not supported\");\n\t\t}\n  } catch (err) {\n    return {};\n  }\n  return {\n    hydrateList: function(listData, set) {\n      set = set || this.listSet(listData);\n      var id = sortedSetJSON(set);\n      var list = baseConnection.hydrateList.call(this, listData, set);//instance of list constructor\n\n      if (this._getHydrateListCallbacks[id]) {\n        this._getHydrateListCallbacks[id].shift()(list);\n        if (!this._getHydrateListCallbacks[id].length){\n          delete this._getHydrateListCallbacks[id];\n        }\n      }\n      return list;\n    },\n    _getHydrateListCallbacks: {},\n    _getHydrateList: function(set, callback) {\n      var id = sortedSetJSON(set);\n      if (!this._getHydrateListCallbacks[id]) {\n        this._getHydrateListCallbacks[id] = [];\n      }\n      this._getHydrateListCallbacks[id].push(callback);\n    },\n    getListData: function(set) {\n      var fetchPromise = fetch(this.ndjson || this.url);\n      this._getHydrateList(set, function(list) {\n        function streamerr(e) {\n          canReflect.setKeyValue(list,\"isStreaming\", false);\n          canReflect.setKeyValue(list,\"streamError\", e);\n        }\n\n        fetchPromise.then(function(response) {\n          canReflect.setKeyValue(list,\"isStreaming\", true);\n          return ndJSONStream(response.body);\n        }).then(function(itemStream) {\n          var reader = itemStream.getReader();\n          reader.read().then(function read(result) {\n            if (result.done) {\n              canReflect.setKeyValue(list,\"isStreaming\", false);\n              return;\n            }\n            list.push(result.value);\n            reader.read().then(read, streamerr);\n          }, streamerr);\n        });\n      });\n\n      return fetchPromise.then(function() {\n        return {\n          data: []\n        };\n      });\n    }\n  };\n});\n\nmodule.exports = namespace.connectNdjson = connectNdjson;\n"],"names":["connectNdjson","connect","behavior","baseConnection","ReadableStream","window","fetch","Error","err","hydrateList","listData","set","this","listSet","id","sortedSetJSON","list","call","_getHydrateListCallbacks","shift","length","_getHydrateList","callback","push","getListData","fetchPromise","ndjson","url","streamerr","e","canReflect","setKeyValue","then","response","ndJSONStream","body","itemStream","reader","getReader","read","result","done","value","data","namespace"],"mappings":"qYAQA,IAAIA,cAAgBC,QAAQC,SAAS,cAAe,SAASC,GAE3D,IAEA,GADE,IAAIC,eACqB,mBAAjBC,OAAOC,MAChB,MAAM,IAAIC,MAAM,uBAEf,MAAOC,GACP,MAAO,GAET,MAAO,CACLC,YAAa,SAASC,EAAUC,GAC9BA,EAAMA,GAAOC,KAAKC,QAAQH,GAC1B,IAAII,EAAKC,cAAcJ,GACnBK,EAAOb,EAAeM,YAAYQ,KAAKL,KAAMF,EAAUC,GAQ3D,OANIC,KAAKM,yBAAyBJ,KAChCF,KAAKM,yBAAyBJ,GAAIK,OAAlCP,CAA0CI,GACrCJ,KAAKM,yBAAyBJ,GAAIM,eAC9BR,KAAKM,yBAAyBJ,IAGlCE,GAETE,yBAA0B,GAC1BG,gBAAiB,SAASV,EAAKW,GAC7B,IAAIR,EAAKC,cAAcJ,GAClBC,KAAKM,yBAAyBJ,KACjCF,KAAKM,yBAAyBJ,GAAM,IAEtCF,KAAKM,yBAAyBJ,GAAIS,KAAKD,IAEzCE,YAAa,SAASb,GACpB,IAAIc,EAAenB,MAAMM,KAAKc,QAAUd,KAAKe,KAuB7C,OAtBAf,KAAKS,gBAAgBV,EAAK,SAASK,GACjC,SAASY,EAAUC,GACjBC,WAAWC,YAAYf,EAAK,eAAe,GAC3Cc,WAAWC,YAAYf,EAAK,cAAea,GAG7CJ,EAAaO,KAAK,SAASC,GAEzB,OADAH,WAAWC,YAAYf,EAAK,eAAe,GACpCkB,gBAAaD,EAASE,QAC5BH,KAAK,SAASI,GACf,IAAIC,EAASD,EAAWE,YACxBD,EAAOE,OAAOP,KAAK,SAASO,EAAKC,GAC3BA,EAAOC,KACTX,WAAWC,YAAYf,EAAK,eAAe,IAG7CA,EAAKO,KAAKiB,EAAOE,OACjBL,EAAOE,OAAOP,KAAKO,EAAMX,KACxBA,OAIAH,EAAaO,KAAK,WACvB,MAAO,CACLW,KAAM,2BAOCC,UAAU5C,cAAgBA"}