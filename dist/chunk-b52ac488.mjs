import"./chunk-5f1245ff.mjs";import{a as canReflect}from"./chunk-7e0220de.mjs";function getItems(e){return Array.isArray(e)?e:e.data}function indexOf(e,t,r){for(var i=canReflect.getSchema(r),a=0;a<e.length;a++)if(t===canReflect.getIdentity(e[a],i))return a;return-1}function makeSimpleStore(e){e.constructor=makeSimpleStore;var t=Object.create(e);return canReflect.assignMap(t,{getRecordFromParams:function(e){var t=canReflect.getIdentity(e,this.queryLogic.schema);return this.getRecord(t)},log:function(){this._log=!0},getSets:function(){return this.getQueries()},getQueries:function(){return Promise.resolve(this.getQueriesSync())},getQueriesSync:function(){return this.getQueryDataSync().map(function(e){return e.query})},getListData:function(e){e=e||{};var t=this.getListDataSync(e);return t?Promise.resolve(t):Promise.reject({title:"no data",status:"404",detail:"No data available for this query.\nAvailable queries: "+JSON.stringify(this.getQueriesSync())})},getPaginatedListDataSync:function(e){var t=this.getAllRecords(),r=this.queryLogic.removePagination(e.query),i=this.queryLogic.filterMembersAndGetCount(r,{},t),a=indexOf(i.data,e.startIdentity,this.queryLogic),s=i.data.slice(a,a+this.queryLogic.count(e.query));return{count:i.data.length,data:s}},getListDataSync:function(e){for(var t,r=this.getQueryDataSync(),i=this.queryLogic.isPaginated(e),a=0;a<r.length;a++){var s=r[a].query;this.queryLogic.isSubset(e,s)&&(t=r[a])}var n=this.getAllRecords();if(i&&this.queryLogic.isPaginated(t.query)){var c=this.getPaginatedListDataSync(t);return this.queryLogic.filterMembersAndGetCount(e,t.query,c.data)}var o=this.queryLogic.filterMembersAndGetCount(e,{},n);return o&&o.count?o:t?{count:0,data:[]}:void 0},updateListData:function(e,t){var r=this.getQueryDataSync();t=t||{};var i=getItems(canReflect.serialize(e));this.updateRecordsSync(i);var a=this.queryLogic.isPaginated(t),s=i.length?canReflect.getIdentity(i[0],this.queryLogic.schema):void 0;if(a){for(var n=0;n<r.length;n++){var c=r[n].query,o=this.queryLogic.union(c,t);if(this.queryLogic.isDefinedAndHasMembers(o)){var u=this.getPaginatedListDataSync(r[n]),g=this.queryLogic.unionMembers(c,t,u.data,i);return s=canReflect.getIdentity(g[0],this.queryLogic.schema),r[n]={query:o,startIdentity:s},this.updateQueryDataSync(r),Promise.resolve()}}return r.push({query:t,startIdentity:s}),this.updateQueryDataSync(r),Promise.resolve()}var h=this.getAllRecords(),y=this.queryLogic.filterMembers(t,h);if(y.length){var d=new Map;y.forEach(function(e){d.set(canReflect.getIdentity(e,this.queryLogic.schema),e)},this),i.forEach(function(e){d.delete(canReflect.getIdentity(e,this.queryLogic.schema))},this),this.destroyRecords(canReflect.toArray(d.values()))}var l=this.getQueryDataSync().filter(function(e){return!this.queryLogic.isSubset(e.query,t)},this);return l.filter(function(e){return this.queryLogic.isSubset(t,e.query)},this).length?this.updateQueryDataSync(l):this.updateQueryDataSync(l.concat([{query:t,startIdentity:s}])),Promise.resolve()},getData:function(e){var t=canReflect.getIdentity(e,canReflect.getSchema(this.queryLogic)),r=this.getRecord(t);return r?Promise.resolve(r):Promise.reject({title:"no data",status:"404",detail:"No record with matching identity ("+t+")."})},createData:function(e){return this.updateRecordsSync([e]),Promise.resolve(canReflect.assignMap({},this.getRecordFromParams(e)))},updateData:function(e){if(this.errorOnMissingRecord&&!this.getRecordFromParams(e)){var t=canReflect.getIdentity(e,this.queryLogic.schema);return Promise.reject({title:"no data",status:"404",detail:"No record with matching identity ("+t+")."})}return this.updateRecordsSync([e]),Promise.resolve(canReflect.assignMap({},this.getRecordFromParams(e)))},destroyData:function(e){var t=canReflect.getIdentity(e,this.queryLogic.schema),r=this.getRecordFromParams(e);return this.errorOnMissingRecord&&!r?Promise.reject({title:"no data",status:"404",detail:"No record with matching identity ("+t+")."}):(this.destroyRecords([e]),Promise.resolve(canReflect.assignMap({},r||e)))}})}var makeSimpleStore_1=makeSimpleStore;export{makeSimpleStore_1 as a};
//# sourceMappingURL=chunk-b52ac488.js.map
