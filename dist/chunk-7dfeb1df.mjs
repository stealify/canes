import"./chunk-5f1245ff.mjs";import{a as canReflect}from"./chunk-7e0220de.mjs";import{a as process$1}from"./chunk-bacf0c54.mjs";import"./chunk-805ffcb4.mjs";import"./chunk-862b179d.mjs";import"./chunk-fa6b878a.mjs";import{a as canSymbol}from"./chunk-b37d91a1.mjs";import{a as dev}from"./chunk-585d4076.mjs";import"./chunk-79943599.mjs";import{a as namespace}from"./chunk-3b4c7b38.mjs";import{a as queues}from"./chunk-12ed728f.mjs";import{a as ObservationRecorder}from"./chunk-8811d387.mjs";import{a as valueEventBindings}from"./chunk-825526fa.mjs";function addNewKeyDependenciesIfNotInOld(e){void 0!==this.oldEventSet&&!1!==this.oldEventSet.delete(e)||canReflect.onKeyValue(this.observable,e,this.onDependencyChange,"notify")}function addObservablesNewKeyDependenciesIfNotInOld(e,n){e.forEach(addNewKeyDependenciesIfNotInOld,{onDependencyChange:this.onDependencyChange,observable:n,oldEventSet:this.oldDependencies.keyDependencies.get(n)})}function removeKeyDependencies(e){canReflect.offKeyValue(this.observable,e,this.onDependencyChange,"notify")}function removeObservablesKeyDependencies(e,n){e.forEach(removeKeyDependencies,{onDependencyChange:this.onDependencyChange,observable:n})}function addValueDependencies(e){!1===this.oldDependencies.valueDependencies.delete(e)&&canReflect.onValue(e,this.onDependencyChange,"notify")}function removeValueDependencies(e){canReflect.offValue(e,this.onDependencyChange,"notify")}var observables,recorderDependencyHelpers={updateObservations:function(e){e.newDependencies.keyDependencies.forEach(addObservablesNewKeyDependenciesIfNotInOld,e),e.oldDependencies.keyDependencies.forEach(removeObservablesKeyDependencies,e),e.newDependencies.valueDependencies.forEach(addValueDependencies,e),e.oldDependencies.valueDependencies.forEach(removeValueDependencies,e)},stopObserving:function(e,n){e.keyDependencies.forEach(removeObservablesKeyDependencies,{onDependencyChange:n}),e.valueDependencies.forEach(removeValueDependencies,{onDependencyChange:n})}},temporarilyBoundNoOperation=function(){},unbindTemporarilyBoundValue=function(){for(var e=0,n=observables.length;e<n;e++)canReflect.offValue(observables[e],temporarilyBoundNoOperation);observables=null};function temporarilyBind(e){var n=e.computeInstance||e;canReflect.onValue(n,temporarilyBoundNoOperation),observables||(observables=[],setTimeout(unbindTemporarilyBoundValue,10)),observables.push(n)}var temporarilyBind_1=temporarilyBind,dispatchSymbol=canSymbol.for("can.dispatch"),getChangesSymbol=canSymbol.for("can.getChangesDependencyRecord"),getValueDependenciesSymbol=canSymbol.for("can.getValueDependencies");function Observation(e,n,t){this.func=e,this.context=n,this.options=t||{priority:0,isObservable:!0},this.bound=!1,this._value=void 0,this.newDependencies=ObservationRecorder.makeDependenciesRecord(),this.oldDependencies=null;var i=this;this.onDependencyChange=function(e){i.dependencyChange(this,e)},this.update=this.update.bind(this),"production"!==process$1.env.NODE_ENV&&(this.onDependencyChange[getChangesSymbol]=function(){var e=new Set;return e.add(i),{valueDependencies:e}},Object.defineProperty(this.onDependencyChange,"name",{value:canReflect.getName(this)+".onDependencyChange"}),Object.defineProperty(this.update,"name",{value:canReflect.getName(this)+".update"}))}valueEventBindings(Observation.prototype),canReflect.assign(Observation.prototype,{onBound:function(){this.bound=!0,this.oldDependencies=this.newDependencies,ObservationRecorder.start(),this._value=this.func.call(this.context),this.newDependencies=ObservationRecorder.stop(),recorderDependencyHelpers.updateObservations(this)},dependencyChange:function(e,n){if(!0===this.bound){var t=[];t=[this.update,this,[],{priority:this.options.priority}],"production"!==process$1.env.NODE_ENV&&(t=[this.update,this,[],{priority:this.options.priority,log:[canReflect.getName(this.update)]},[canReflect.getName(e),"changed"]]),queues.deriveQueue.enqueue.apply(queues.deriveQueue,t)}},update:function(){if(!0===this.bound){var e=this._value;this.oldValue=null,this.onBound(),e!==this._value&&this[dispatchSymbol](this._value,e)}},onUnbound:function(){this.bound=!1,recorderDependencyHelpers.stopObserving(this.newDependencies,this.onDependencyChange),this.newDependencies=ObservationRecorder.makeDependenciesRecorder()},get:function(){return this.options.isObservable&&ObservationRecorder.isRecording()&&(ObservationRecorder.add(this),this.bound||Observation.temporarilyBind(this)),!0===this.bound?(queues.deriveQueue.tasksRemainingCount()>0&&Observation.updateChildrenAndSelf(this),this._value):this.func.call(this.context)},hasDependencies:function(){var e=this.newDependencies;return this.bound?e.valueDependencies.size+e.keyDependencies.size>0:void 0},log:function(){if("production"!==process$1.env.NODE_ENV){var e=function(e){return"string"==typeof e?JSON.stringify(e):e};this._log=function(n,t){dev.log(canReflect.getName(this),"\n is  ",e(t),"\n was ",e(n))}}}}),Object.defineProperty(Observation.prototype,"value",{get:function(){return this.get()}});var observationProto={"can.getValue":Observation.prototype.get,"can.isValueLike":!0,"can.isMapLike":!1,"can.isListLike":!1,"can.valueHasDependencies":Observation.prototype.hasDependencies,"can.getValueDependencies":function(){if(!0===this.bound){var e=this.newDependencies,n={};return e.keyDependencies.size&&(n.keyDependencies=e.keyDependencies),e.valueDependencies.size&&(n.valueDependencies=e.valueDependencies),n}},"can.getPriority":function(){return this.options.priority},"can.setPriority":function(e){this.options.priority=e}};"production"!==process$1.env.NODE_ENV&&(observationProto["can.getName"]=function(){return canReflect.getName(this.constructor)+"<"+canReflect.getName(this.func)+">"}),canReflect.assignSymbols(Observation.prototype,observationProto),Observation.updateChildrenAndSelf=function(e){if(void 0!==e.update&&!0===queues.deriveQueue.isEnqueued(e.update))return queues.deriveQueue.flushQueuedTask(e.update),!0;if(e[getValueDependenciesSymbol]){var n=!1;return(e[getValueDependenciesSymbol]().valueDependencies||[]).forEach(function(e){!0===Observation.updateChildrenAndSelf(e)&&(n=!0)}),n}return!1};var alias={addAll:"addMany"};["add","addAll","ignore","trap","trapsCount","isRecording"].forEach(function(e){Observation[e]=function(){var n=alias[e]?alias[e]:e;return console.warn("can-observation: Call "+n+"() on can-observation-recorder."),ObservationRecorder[n].apply(this,arguments)}}),Observation.prototype.start=function(){return console.warn("can-observation: Use .on and .off to bind."),this.onBound()},Observation.prototype.stop=function(){return console.warn("can-observation: Use .on and .off to bind."),this.onUnbound()},Observation.temporarilyBind=temporarilyBind_1;var canObservation=namespace.Observation=Observation;export{canObservation as a,canObservation as b};
//# sourceMappingURL=chunk-7dfeb1df.js.map
