import{a as canValidateInterface}from"./chunk-834a9a33.mjs";import"./chunk-5f1245ff.mjs";import{a as canReflect}from"./chunk-7e0220de.mjs";import{a as diff}from"./chunk-3f0a7243.mjs";import{a as behavior}from"./chunk-54c27a9a.mjs";import{a as get}from"./chunk-b09dcf0e.mjs";import"./chunk-805ffcb4.mjs";import{a as namespace}from"./chunk-3b4c7b38.mjs";import{a as canSymbol}from"./chunk-b37d91a1.mjs";import{a as canAjax}from"./chunk-ed157244.mjs";import{a as process$1}from"./chunk-bacf0c54.mjs";import{a as commonjsGlobal,b as commonjsRequire,c as unwrapExports,d as createCommonjsModule}from"./chunk-eae5b219.mjs";import{a as replaceWith}from"./chunk-f0afc07a.mjs";import{a as dev}from"./chunk-585d4076.mjs";import"./chunk-862b179d.mjs";import"./chunk-f8a6947c.mjs";import"./chunk-fa6b878a.mjs";import"./chunk-0826a8c3.mjs";import{a as mergeDeep}from"./chunk-1e549d43.mjs";import{a as queues}from"./chunk-12ed728f.mjs";import{a as mapEventBindings}from"./chunk-910f3205.mjs";import{a as ObservationRecorder}from"./chunk-8811d387.mjs";import{a as QueryLogic}from"./chunk-723b8216.mjs";var validate=function(e,t){var n=validateArgumentInterface(e,0,t,function(t,n){throw new BehaviorInterfaceError(n,e,t)});return Object.keys(e).forEach(function(t){n[t]=e[t]}),n.__interfaces=t,n};function validateArgumentInterface(e,t,n,a){return function(){var r=canValidateInterface(n)(arguments[t]);return r&&a&&a(r,arguments[t]),e.apply(this,arguments)}}function BehaviorInterfaceError(e,t,n){var a='can-connect: Extending behavior "'+(t.behaviorName||"anonymous behavior")+'" found base behavior "'+(e.__behaviorName||"anonymous behavior")+'" was missing required properties: '+JSON.stringify(n.related),r=new Error(a);return Object.setPrototypeOf&&Object.setPrototypeOf(r,Object.getPrototypeOf(this)),r}BehaviorInterfaceError.prototype=Object.create(Error.prototype,{constructor:{value:Error}}),Object.setPrototypeOf?Object.setPrototypeOf(BehaviorInterfaceError,Error):BehaviorInterfaceError.__proto__=Error;var assign=canReflect.assignMap,WeakReferenceMap=function(){this.set={}};assign(WeakReferenceMap.prototype,{has:function(e){return!!this.set[e]},addReference:function(e,t,n){if(void 0===e)throw new Error("can-connect: You must provide a key to store a value in a WeakReferenceMap");var a=this.set[e];a||(a=this.set[e]={item:t,referenceCount:0,key:e}),a.referenceCount+=n||1},referenceCount:function(e){var t=this.set[e];if(t)return t.referenceCount},deleteReference:function(e){var t=this.set[e];t&&(t.referenceCount--,0===t.referenceCount&&delete this.set[e])},get:function(e){var t=this.set[e];if(t)return t.item},forEach:function(e){for(var t in this.set)e(this.set[t].item,t)}});var weakReferenceMap=WeakReferenceMap,updateDeepExceptIdentity=function(e,t,n){if(n||(n=canReflect.getSchema(e)),!n)throw new Error("can-diff/update-except-id is unable to update without a schema.");n.identity.forEach(function(n){var a=canReflect.getKeyValue(e,n);void 0!==a&&canReflect.setKeyValue(t,n,a)}),canReflect.updateDeep(e,t)},idMerge=function(e,t,n,a){diff(e,t,function(e,t){return n(e)===n(t)}).forEach(function(t){canReflect.splice(e,t.index,t.deleteCount,t.insert.map(a))})},makeArray=canReflect.toArray,assign$1=canReflect.assignMap,constructor_1=behavior("constructor",function(e){return{cidStore:new weakReferenceMap,_cid:0,get:function(e){var t=this;return this.getData(e).then(function(e){return t.hydrateInstance(e)})},getList:function(e){e=e||{};var t=this;return this.getListData(e).then(function(n){return t.hydrateList(n,e)})},hydrateList:function(e,t){Array.isArray(e)&&(e={data:e});for(var n=[],a=0;a<e.data.length;a++)n.push(this.hydrateInstance(e.data[a]));if(e.data=n,this.list)return this.list(e,t);var r=e.data.slice(0);return r[this.listQueryProp||"__listQuery"]=t,copyMetadata(e,r),r},hydrateInstance:function(e){return this.instance?this.instance(e):assign$1({},e)},save:function(e){var t=this.serializeInstance(e),n=this.id(e),a=this;if(void 0===n){var r=this._cid++;return this.cidStore.addReference(r,e),this.createData(t,r).then(function(t){return void 0!==t&&a.createdInstance(e,t),a.cidStore.deleteReference(r,e),e})}return this.updateData(t).then(function(t){return void 0!==t&&a.updatedInstance(e,t),e})},destroy:function(e){var t=this.serializeInstance(e),n=this;return this.destroyData(t).then(function(t){return void 0!==t&&n.destroyedInstance(e,t),e})},createdInstance:function(e,t){assign$1(e,t)},updatedInstance:function(e,t){updateDeepExceptIdentity(e,t,this.queryLogic.schema)},updatedList:function(e,t,n){for(var a=[],r=0;r<t.data.length;r++)a.push(this.hydrateInstance(t.data[r]));idMerge(e,a,this.id.bind(this),this.hydrateInstance.bind(this)),copyMetadata(t,e)},destroyedInstance:function(e,t){updateDeepExceptIdentity(e,t,this.queryLogic.schema)},serializeInstance:function(e){return assign$1({},e)},serializeList:function(e){var t=this;return makeArray(e).map(function(e){return t.serializeInstance(e)})},isNew:function(e){var t=this.id(e);return!(t||0===t)}}});function copyMetadata(e,t){for(var n in e)"data"!==n&&("function"==typeof t.set?t.set(n,e[n]):"function"==typeof t.attr?t.attr(n,e[n]):t[n]=e[n])}var each=canReflect.each,parse=behavior("data/parse",function(e){var t={parseListData:function(t){var n;if(e.parseListData&&(t=e.parseListData.apply(this,arguments)),Array.isArray(t))n={data:t};else{var a=this.parseListProp||"data";if(t.data=get(t,a),n=t,"data"!==a&&delete t[a],!Array.isArray(n.data))throw new Error("Could not get any raw data while converting using .parseListData")}for(var r=[],i=0;i<n.data.length;i++)r.push(this.parseInstanceData(n.data[i]));return n.data=r,n},parseInstanceData:function(t){return e.parseInstanceData&&(t=e.parseInstanceData.apply(this,arguments)||t),this.parseInstanceProp&&get(t,this.parseInstanceProp)||t}};return each(pairs,function(n,a){t[a]=function(t){var r=this;return e[a].call(this,t).then(function(){return r[n].apply(r,arguments)})}}),t}),pairs={getListData:"parseListData",getData:"parseInstanceData",createData:"parseInstanceData",updateData:"parseInstanceData",destroyData:"parseInstanceData"};function isArrayLike(e){var t=typeof e;if("string"===t)return!0;if("number"===t)return!1;var n=e&&"boolean"!==t&&"number"!=typeof e&&"length"in e&&e.length;return"function"!=typeof e&&(0===n||"number"==typeof n&&n>0&&n-1 in e)}var isArrayLike_1=namespace.isArrayLike=isArrayLike,isIterable=function(e){return e&&!!e[canSymbol.iterator||canSymbol.for("iterator")]},has=Object.prototype.hasOwnProperty;function each$1(e,t,n){var a,r,i,c=0;if(e)if(isArrayLike_1(e))for(r=e.length;c<r&&(i=e[c],!1!==t.call(n||i,i,c,e));c++);else if(isIterable(e))for(var s,o,u=e[canSymbol.iterator||canSymbol.for("iterator")]();!(s=u.next()).done;)o=s.value,t.call(n||e,Array.isArray(o)?o[1]:o,o[0]);else if("object"==typeof e)for(a in e)if(has.call(e,a)&&!1===t.call(n||e[a],e[a],a,e))break;return e}var each_1=namespace.each=each$1,methodMapping={item:{GET:"getData",PUT:"updateData",DELETE:"destroyData"},list:{GET:"getListData",POST:"createData"}};function inferIdProp(e){var t=e.match(/\{(.*)\}/);if(t&&2===t.length)return t[1]}function getItemAndListUrls(e,t){t=t||inferIdProp(e)||"id";var n=new RegExp("\\/\\{"+t+"\\}.*"),a=n.test(e),r=a?e.replace(n,""):e;return{item:a?e:e.trim()+"/{"+t+"}",list:r}}var canMakeRest=function(e,t){var n={};return each_1(getItemAndListUrls(e,t),function(e,t){each_1(methodMapping[t],function(t,a){n[t]={method:a,url:e}})}),n},makePromise=function(e){return e&&"function"==typeof e.then&&!canReflect.isPromise(e)?new Promise(function(t,n){e.then(t,n)}):e},url=createCommonjsModule(function(e){var t=canMakeRest("/resource/{id}"),n=behavior("data/url",function(e){var n={};return canReflect.eachKey(t,function(t,i){n[i]=function(n){var s=a[i];if("object"==typeof this.url){if("function"==typeof this.url[i])return makePromise(this.url[i](n));if(this.url[i]){var o=c(this.url[i],n,t.method,this.ajax||canAjax,r(this.url,t.method),s);return makePromise(o)}}var u="string"==typeof this.url?this.url:this.url.resource;if(u){var f=canReflect.getSchema(this.queryLogic).identity,p=u.replace(/\/+$/,""),h=canMakeRest(p,f[0])[i];return makePromise(c(h.url,n,h.method,this.ajax||canAjax,r(this.url,h.method),s))}return e[name].call(this,n)}}),n}),a={getListData:{},getData:{},createData:{},updateData:{},destroyData:{includeData:!1}},r=function(e,t){if("object"==typeof e&&e.contentType){if("application/x-www-form-urlencoded"===e.contentType||"application/json"===e.contentType)return e.contentType;"production"!==process$1.env.NODE_ENV&&dev.warn("Unacceptable contentType on can-connect request. Use 'application/json' or 'application/x-www-form-urlencoded'")}return"GET"===t?"application/x-www-form-urlencoded":"application/json"};function i(e,t){return encodeURIComponent(t)}var c=function(e,t,n,a,r,c){var s={};if("string"==typeof e){var o=e.split(/\s+/);s.url=o.pop(),o.length&&(s.type=o.pop())}else canReflect.assignMap(s,e);return s.data="object"!=typeof t||Array.isArray(t)?t:canReflect.assignMap(s.data||{},t),s.url=replaceWith(s.url,s.data,i,!0),s.contentType=r,!1===c.includeData&&delete s.data,a(canReflect.assignMap({type:n||"post",dataType:"json"},s))};if(e.exports=n,"production"!==process$1.env.NODE_ENV){var s=validate;e.exports=s(n,["url"])}}),assignDeepExceptIdentity=function(e,t,n){if(n||(n=canReflect.getSchema(e)),!n)throw new Error("can-diff/update-except-id is unable to update without a schema.");n.identity.forEach(function(n){var a=canReflect.getKeyValue(e,n);void 0!==a&&canReflect.setKeyValue(t,n,a)}),canReflect.assignDeep(e,t)},map$1=createCommonjsModule(function(e){var t=canReflect.each,n=canReflect.isPlainObject,a=canSymbol.for("can.getName");var r=behavior("can/map",function(e){var n={init:function(){if(!this.Map)throw new Error("can-connect/can/map/map must be configured with a Map type");if(this[a]||(this[a]=function(){return this.name?"Connection{"+this.name+"}":this.Map?"Connection{"+canReflect.getName(this.Map)+"}":"string"==typeof this.url?"Connection{"+this.url+"}":"Connection{}"}),this.List=this.List||this.Map.List,!this.List)throw new Error("can-connect/can/map/map - "+canReflect.getName(this)+" must be configured with a List type.");s(this,this.Map,i),s(this,this.List,c),this.queryLogic||(this.queryLogic=new QueryLogic(this.Map));var t=this;if(this.Map[canSymbol.for("can.onInstanceBoundChange")]){var n=function(e,n){var a=n?"addInstanceReference":"deleteInstanceReference";t[a]&&t[a](e)};Object.defineProperty(n,"name",{value:canReflect.getName(this.Map)+" boundChange",configurable:!0}),this.Map[canSymbol.for("can.onInstanceBoundChange")](n)}else console.warn("can-connect/can/map is unable to listen to onInstanceBoundChange on the Map type");if(this.List[canSymbol.for("can.onInstanceBoundChange")]){var r=function(e,n){var a=n?"addListReference":"deleteListReference";t[a]&&t[a](e)};Object.defineProperty(r,"name",{value:canReflect.getName(this.List)+" boundChange",configurable:!0}),this.List[canSymbol.for("can.onInstanceBoundChange")](r)}else console.warn("can-connect/can/map is unable to listen to onInstanceBoundChange on the List type");this.Map[canSymbol.for("can.onInstancePatches")]?this.Map[canSymbol.for("can.onInstancePatches")](function(e,n){n.forEach(function(n){"add"!==n.type&&"set"!==n.type||n.key!==t.idProp||!e[canSymbol.for("can.isBound")]()||t.addInstanceReference(e)})}):console.warn("can-connect/can/map is unable to listen to onInstancePatches on the Map type"),e.init.apply(this,arguments)},serializeInstance:function(e){return canReflect.serialize(e)},serializeList:function(e){return canReflect.serialize(e)},instance:function(e){return new(0,this.Map)(e)},list:function(e,t){var n=new(this.List||this.Map&&this.Map.List)(e.data);return canReflect.eachKey(e,function(e,t){"data"!==t&&canReflect.setKeyValue(n,t,e)}),n[this.listQueryProp]=t,n},updatedList:function(t,n,a){queues.batch.start();var r={};"production"!==process$1.env.NODE_ENV&&(r={reasonLog:["set",a,"list",t,"updated with",n]}),queues.mutateQueue.enqueue(e.updatedList,this,arguments,r),queues.batch.stop()},save:function(t){canReflect.setKeyValue(t,"_saving",!0);var n=function(){canReflect.setKeyValue(t,"_saving",!1)},a=e.save.apply(this,arguments);return a.then(n,n),a},destroy:function(t){canReflect.setKeyValue(t,"_destroying",!0);var n=function(){canReflect.setKeyValue(t,"_destroying",!1)},a=e.destroy.apply(this,arguments);return a.then(n,n),a}};return t(["created","updated","destroyed"],function(e){n[e+"Instance"]=function(t,n){n&&"object"==typeof n&&("destroyed"===e&&0===canReflect.size(n)||(this.constructor.removeAttr?updateDeepExceptIdentity(t,n,this.queryLogic.schema):this.updateInstanceWithAssignDeep?assignDeepExceptIdentity(t,n,this.queryLogic.schema):function(e,t,n){if(n||(n=canReflect.getSchema(e)),!n)throw new Error("can-connect/can/map/ is unable to update without a schema.");n.identity.forEach(function(n){var a=canReflect.getKeyValue(e,n);void 0!==a&&canReflect.setKeyValue(t,n,a)}),mergeDeep(e,t)}(t,n,this.queryLogic.schema))),"created"===e&&this.moveCreatedInstanceToInstanceStore&&this.moveCreatedInstanceToInstanceStore(t),r.callbackInstanceEvents(e,t)}}),n});r.callbackInstanceEvents=function(e,t){var n=t.constructor;queues.batch.start(),mapEventBindings.dispatch.call(t,{type:e,target:t}),"production"!==process$1.env.NODE_ENV&&this.id&&dev.log("can-connect/can/map/map.js - "+(n.shortName||this.name)+" "+this.id(t)+" "+e),mapEventBindings.dispatch.call(n,e,[t]),queues.batch.stop()};var i={static:{getList:function(e,t){return function(e){return t.getList(e)}},findAll:function(e,t){return function(e){return t.getList(e)}},get:function(e,t){return function(e){return t.get(e)}},findOne:function(e,t){return function(e){return t.get(e)}}},prototype:{isNew:function(e,t){return function(){return t.isNew(this)}},isSaving:function(e,t){return function(){return!!canReflect.getKeyValue(this,"_saving")}},isDestroying:function(e,t){return function(){return!!canReflect.getKeyValue(this,"_destroying")}},save:function(e,t){return function(e,n){var a=t.save(this);return a.then(e,n),a}},destroy:function(e,t){return function(e,n){var a;return this.isNew()?(a=Promise.resolve(this),t.destroyedInstance(this,{})):a=t.destroy(this),a.then(e,n),a}}},properties:{_saving:{enumerable:!1,value:!1,configurable:!0,writable:!0},_destroying:{enumerable:!1,value:!1,configurable:!0,writable:!0}}},c={static:{_bubbleRule:function(e,t){return function(t,n){var a=e(t,n);return a.push("destroyed"),a}}},prototype:{setup:function(e,t){return function(a){n(a)&&!Array.isArray(a)?(this[t.listQueryProp]=a,e.apply(this),this.replace(canReflect.isPromise(a)?a:t.getList(a))):e.apply(this,arguments)}}},properties:{}},s=function(e,t,n){var a;for(a in n.properties)canReflect.defineInstanceKey(t,a,n.properties[a]);for(a in n.prototype)t.prototype[a]=n.prototype[a](t.prototype[a],e);if(n.static)for(a in n.static)t[a]=n.static[a](t[a],e)};if(e.exports=r,"production"!==process$1.env.NODE_ENV){var o=validate;e.exports=o(r,["id","get","updatedList","destroy","save","getList"])}});export{validate as a,weakReferenceMap as b,constructor_1 as c,map$1 as d,parse as e,url as f};
//# sourceMappingURL=chunk-4c04edbb.js.map
