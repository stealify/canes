{"version":3,"file":"chunk-2b1fdbc0.js","sources":["../node_modules/can-reflect-promise/can-reflect-promise.js"],"sourcesContent":["\"use strict\";\nvar canReflect = require(\"can-reflect\");\nvar canSymbol = require(\"can-symbol\");\nvar ObservationRecorder = require(\"can-observation-recorder\");\nvar queues = require(\"can-queues\");\nvar KeyTree = require(\"can-key-tree\");\nvar dev = require(\"can-log/dev/dev\");\n\n\nvar getKeyValueSymbol = canSymbol.for(\"can.getKeyValue\"),\n\tobserveDataSymbol = canSymbol.for(\"can.meta\");\n\nvar promiseDataPrototype = {\n\tisPending: true,\n\tstate: \"pending\",\n\tisResolved: false,\n\tisRejected: false,\n\tvalue: undefined,\n\treason: undefined\n};\n\nfunction setVirtualProp(promise, property, value) {\n\tvar observeData = promise[observeDataSymbol];\n\tvar old = observeData[property];\n\tobserveData[property] = value;\n\tqueues.enqueueByQueue(observeData.handlers.getNode([property]), promise, [value,old], function() {\n\t\treturn {};\n\t},[\"Promise\", promise, \"resolved with value\", value, \"and changed virtual property: \"+property]);\n}\n\nfunction initPromise(promise) {\n\tvar observeData = promise[observeDataSymbol];\n\tif(!observeData) {\n\t\tObject.defineProperty(promise, observeDataSymbol, {\n\t\t\tenumerable: false,\n\t\t\tconfigurable: false,\n\t\t\twritable: false,\n\t\t\tvalue: Object.create(promiseDataPrototype)\n\t\t});\n\t\tobserveData = promise[observeDataSymbol];\n\t\tobserveData.handlers = new KeyTree([Object, Object, Array]);\n\t}\n\tpromise.then(function(value){\n\t\tqueues.batch.start();\n\t\tsetVirtualProp(promise, \"isPending\", false);\n\t\tsetVirtualProp(promise, \"isResolved\", true);\n\t\tsetVirtualProp(promise, \"value\", value);\n\t\tsetVirtualProp(promise, \"state\", \"resolved\");\n\t\tqueues.batch.stop();\n\t}, function(reason){\n\t\tqueues.batch.start();\n\t\tsetVirtualProp(promise, \"isPending\", false);\n\t\tsetVirtualProp(promise, \"isRejected\", true);\n\t\tsetVirtualProp(promise, \"reason\", reason);\n\t\tsetVirtualProp(promise, \"state\", \"rejected\");\n\t\tqueues.batch.stop();\n\n\t\t//!steal-remove-start\n\t\tif (process.env.NODE_ENV !== 'production') {\n\t\t\tdev.error(\"Failed promise:\", reason);\n\t\t}\n\t\t//!steal-remove-end\n\t});\n}\n\nfunction setupPromise(value) {\n\tvar oldPromiseFn;\n\tvar proto = \"getPrototypeOf\" in Object ? Object.getPrototypeOf(value) : value.__proto__; //jshint ignore:line\n\n\tif(value[getKeyValueSymbol] && value[observeDataSymbol]) {\n\t\t// promise has already been set up.  Don't overwrite.\n\t\treturn;\n\t}\n\n\tif(proto === null || proto === Object.prototype) {\n\t\t// promise type is a plain object or dictionary.  Set up object instead of proto.\n\t\tproto = value;\n\n\t\tif(typeof proto.promise === \"function\") {\n\t\t\t// Duck-type identification as a jQuery.Deferred;\n\t\t\t// In that case, the promise() function returns a new object\n\t\t\t//  that needs to be decorated.\n\t\t\toldPromiseFn = proto.promise;\n\t\t\tproto.promise = function() {\n\t\t\t\tvar result = oldPromiseFn.call(proto);\n\t\t\t\tsetupPromise(result);\n\t\t\t\treturn result;\n\t\t\t};\n\t\t}\n\t}\n\n\tcanReflect.assignSymbols(proto, {\n\t\t\"can.getKeyValue\": function(key) {\n\t\t\tif(!this[observeDataSymbol]) {\n\t\t\t\tinitPromise(this);\n\t\t\t}\n\n\t\t\tObservationRecorder.add(this, key);\n\t\t\tswitch(key) {\n\t\t\t\tcase \"state\":\n\t\t\t\tcase \"isPending\":\n\t\t\t\tcase \"isResolved\":\n\t\t\t\tcase \"isRejected\":\n\t\t\t\tcase \"value\":\n\t\t\t\tcase \"reason\":\n\t\t\t\treturn this[observeDataSymbol][key];\n\t\t\t\tdefault:\n\t\t\t\treturn this[key];\n\t\t\t}\n\t\t},\n\t\t\"can.getValue\": function() {\n\t\t\treturn this[getKeyValueSymbol](\"value\");\n\t\t},\n\t\t\"can.isValueLike\": false,\n\t\t\"can.onKeyValue\": function(key, handler, queue) {\n\t\t\tif(!this[observeDataSymbol]) {\n\t\t\t\tinitPromise(this);\n\t\t\t}\n\t\t\tthis[observeDataSymbol].handlers.add([key, queue || \"mutate\", handler]);\n\t\t},\n\t\t\"can.offKeyValue\": function(key, handler, queue) {\n\t\t\tif(!this[observeDataSymbol]) {\n\t\t\t\tinitPromise(this);\n\t\t\t}\n\t\t\tthis[observeDataSymbol].handlers.delete([key, queue || \"mutate\", handler]);\n\t\t},\n\t\t\"can.hasOwnKey\": function(key) {\n\t\t\tif (!this[observeDataSymbol]) {\n\t\t\t\tinitPromise(this);\n\t\t\t}\n\t\t\treturn (key in this[observeDataSymbol]);\n\t\t}\n\t});\n}\n\nmodule.exports = setupPromise;\n"],"names":["getKeyValueSymbol","canSymbol","for","observeDataSymbol","promiseDataPrototype","isPending","state","isResolved","isRejected","value","undefined","reason","setVirtualProp","promise","property","observeData","old","queues","enqueueByQueue","handlers","getNode","initPromise","Object","defineProperty","enumerable","configurable","writable","create","KeyTree","Array","then","batch","start","stop","process","env","NODE_ENV","dev","error","setupPromise","oldPromiseFn","proto","getPrototypeOf","__proto__","prototype","result","call","canReflect","assignSymbols","can.getKeyValue","key","this","ObservationRecorder","add","can.getValue","can.isValueLike","can.onKeyValue","handler","queue","can.offKeyValue","delete","can.hasOwnKey"],"mappings":"gcASA,sBAAIA,kBAAoBC,UAAUC,IAAI,mBACrCC,kBAAoBF,UAAUC,IAAI,YAE/BE,qBAAuB,CAC1BC,WAAW,EACXC,MAAO,UACPC,YAAY,EACZC,YAAY,EACZC,WAAOC,EACPC,YAAQD,GAGT,SAASE,eAAeC,EAASC,EAAUL,GAC1C,IAAIM,EAAcF,EAAQV,mBACtBa,EAAMD,EAAYD,GACtBC,EAAYD,GAAYL,EACxBQ,OAAOC,eAAeH,EAAYI,SAASC,QAAQ,CAACN,IAAYD,EAAS,CAACJ,EAAMO,GAAM,WACrF,MAAO,IACN,CAAC,UAAWH,EAAS,sBAAuBJ,EAAO,iCAAiCK,IAGvF,SAASO,YAAYR,GACpB,IAAIE,EAAcF,EAAQV,mBACtBY,IACHO,OAAOC,eAAeV,EAASV,kBAAmB,CACjDqB,YAAY,EACZC,cAAc,EACdC,UAAU,EACVjB,MAAOa,OAAOK,OAAOvB,yBAEtBW,EAAcF,EAAQV,oBACVgB,SAAW,IAAIS,QAAQ,CAACN,OAAQA,OAAQO,SAErDhB,EAAQiB,KAAK,SAASrB,GACrBQ,OAAOc,MAAMC,QACbpB,eAAeC,EAAS,aAAa,GACrCD,eAAeC,EAAS,cAAc,GACtCD,eAAeC,EAAS,QAASJ,GACjCG,eAAeC,EAAS,QAAS,YACjCI,OAAOc,MAAME,QACX,SAAStB,GACXM,OAAOc,MAAMC,QACbpB,eAAeC,EAAS,aAAa,GACrCD,eAAeC,EAAS,cAAc,GACtCD,eAAeC,EAAS,SAAUF,GAClCC,eAAeC,EAAS,QAAS,YACjCI,OAAOc,MAAME,OAGgB,eAAzBC,UAAQC,IAAIC,UACfC,IAAIC,MAAM,kBAAmB3B,KAMhC,SAAS4B,aAAa9B,GACrB,IAAI+B,EACAC,EAAQ,mBAAoBnB,OAASA,OAAOoB,eAAejC,GAASA,EAAMkC,UAE3ElC,EAAMT,oBAAsBS,EAAMN,qBAKxB,OAAVsC,GAAkBA,IAAUnB,OAAOsB,WAIT,mBAF5BH,EAAQhC,GAEQI,UAIf2B,EAAeC,EAAM5B,QACrB4B,EAAM5B,QAAU,WACf,IAAIgC,EAASL,EAAaM,KAAKL,GAE/B,OADAF,aAAaM,GACNA,IAKVE,WAAWC,cAAcP,EAAO,CAC/BQ,kBAAmB,SAASC,GAM3B,OALIC,KAAKhD,oBACRkB,YAAY8B,MAGbC,oBAAoBC,IAAIF,KAAMD,GACvBA,GACN,IAAK,QACL,IAAK,YACL,IAAK,aACL,IAAK,aACL,IAAK,QACL,IAAK,SACL,OAAOC,KAAKhD,mBAAmB+C,GAC/B,QACA,OAAOC,KAAKD,KAGdI,eAAgB,WACf,OAAOH,KAAKnD,mBAAmB,UAEhCuD,mBAAmB,EACnBC,iBAAkB,SAASN,EAAKO,EAASC,GACpCP,KAAKhD,oBACRkB,YAAY8B,MAEbA,KAAKhD,mBAAmBgB,SAASkC,IAAI,CAACH,EAAKQ,GAAS,SAAUD,KAE/DE,kBAAmB,SAAST,EAAKO,EAASC,GACrCP,KAAKhD,oBACRkB,YAAY8B,MAEbA,KAAKhD,mBAAmBgB,SAASyC,OAAO,CAACV,EAAKQ,GAAS,SAAUD,KAElEI,gBAAiB,SAASX,GAIzB,OAHKC,KAAKhD,oBACTkB,YAAY8B,MAELD,KAAOC,KAAKhD,8BAKNoC,kBAAAA"}