{"version":3,"file":"can-connect-tag.js","sources":["../node_modules/can-connect-tag/can-connect-tag.js"],"sourcesContent":["\n\n\nrequire(\"can-stache-bindings\");\n\nvar Observation = require('can-observation');\nvar expression = require(\"can-stache/src/expression\");\nvar viewCallbacks = require(\"can-view-callbacks\");\nvar ObservationRecorder = require(\"can-observation-recorder\");\nvar nodeLists = require(\"can-view-nodelist\");\nvar canReflect = require(\"can-reflect\");\nvar canSymbol = require(\"can-symbol\");\nvar domMutate = require('can-dom-mutate');\nvar domMutateNode = require(\"can-dom-mutate/node\");\nvar each = require(\"can-reflect\").each;\nvar namespace = require(\"can-namespace\");\n\n\nvar convertToValue = function(arg){\n\tif(typeof arg === \"function\") {\n\t\treturn convertToValue( arg() );\n\t} else {\n\t\treturn arg;\n\t}\n};\n\nfunction connectTag(tagName, connection){\n\n\tvar removeBrackets = function(value, open, close){\n\t\topen = open || \"{\";\n\t\tclose = close || \"}\";\n\n\t\tif(value[0] === open && value[value.length-1] === close) {\n\t\t\treturn value.substr(1, value.length - 2);\n\t\t}\n\t\treturn value;\n\t};\n\n\n\tviewCallbacks.tag(tagName, function(el, tagData){\n\t\tvar getList = el.getAttribute(\"getList\") || el.getAttribute(\"get-list\");\n\t\tvar getInstance = el.getAttribute(\"get\");\n\n\t\tvar attrValue = getList || getInstance;\n\t\tvar method = getList ? \"getList\" : \"get\";\n\n\t\tvar attrInfo = expression.parse('tmp(' + removeBrackets(attrValue)+\")\", {baseMethodType: \"Call\"});\n\t\t// -> {hash: {foo: 'bar', zed: 5, abc: {get: 'myValue'}}}\n\n\n\t\tvar addedToPageData = false;\n\t\tvar addToPageData = ObservationRecorder.ignore(function(set, promise){\n\t\t\tif(!addedToPageData) {\n\t\t\t\tvar root = tagData.scope.peek(\"%root\") || tagData.scope.peek(\"@root\");\n\t\t\t\tif( root && root.pageData ) {\n\t\t\t\t\tif(method === \"get\"){\n\t\t\t\t\t\tset = connection.id(set);\n\t\t\t\t\t}\n\t\t\t\t\troot.pageData(connection.name, set, promise);\n\t\t\t\t}\n\t\t\t}\n\t\t\taddedToPageData = true;\n\t\t});\n\n\t\tvar request = new Observation(function(){\n\t\t\tvar hash = {};\n\t\t\tif(typeof attrInfo.hash === \"object\") {\n\t\t\t\t// old expression data\n\t\t\t\teach(attrInfo.hash, function(val, key) {\n\t\t\t\t\tif (val && val.hasOwnProperty(\"get\")) {\n\t\t\t\t\t\thash[key] = tagData.scope.read(val.get, {}).value;\n\t\t\t\t\t} else {\n\t\t\t\t\t\thash[key] = val;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if(typeof attrInfo.hash === \"function\"){\n\t\t\t\t// new expression data\n\t\t\t\tvar getHash = attrInfo.hash(tagData.scope, tagData.options, {});\n\t\t\t\teach(getHash(), function(val, key) {\n\t\t\t\t\thash[key] = convertToValue(val);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\thash = attrInfo.argExprs.length ? canReflect.getValue(attrInfo.argExprs[0].value(tagData.scope, tagData.options))\n\t\t\t\t\t: {};\n\t\t\t}\n\n\t\t\tvar promise = connection[method](hash);\n\t\t\taddToPageData(hash, promise);\n\t\t\treturn promise;\n\t\t});\n\n\t\tel[canSymbol.for('can.viewModel')] = request;\n\n\t\tvar nodeList = nodeLists.register([], undefined, tagData.parentNodeList || true);\n\n\t\tvar frag = tagData.subtemplate ?\n\t\t\t\t\ttagData.subtemplate( tagData.scope.add(request), tagData.options, nodeList ) :\n\t\t\t\t\tdocument.createDocumentFragment();\n\n\t\t// Append the resulting document fragment to the element\n\t\tdomMutateNode.appendChild.call(el, frag);\n\n\t\t// update the nodeList with the new children so the mapping gets applied\n\t\tnodeLists.update(nodeList, el.childNodes);\n\n\t\tvar removalDisposal = domMutate.onNodeRemoval(el, function () {\n\t\t\tif (!el.ownerDocument.contains(el)) {\n\t\t\t\tremovalDisposal();\n\t\t\t\tnodeLists.unregister(nodeList);\n\t\t\t}\n\t\t});\n\t});\n}\n\nmodule.exports = namespace.connectTag = connectTag;\n"],"names":["each","canReflect","convertToValue","arg","connectTag","tagName","connection","viewCallbacks","tag","el","tagData","value","open","close","getList","getAttribute","getInstance","attrValue","method","attrInfo","expression","parse","length","substr","baseMethodType","addedToPageData","addToPageData","ObservationRecorder","ignore","set","promise","root","scope","peek","pageData","id","name","request","Observation","hash","val","key","hasOwnProperty","read","get","getHash","options","argExprs","getValue","canSymbol","for","nodeList","nodeLists","register","undefined","parentNodeList","frag","subtemplate","add","document","createDocumentFragment","domMutateNode","appendChild","call","update","childNodes","removalDisposal","domMutate","onNodeRemoval","ownerDocument","contains","unregister","namespace"],"mappings":"shEAcA,IAAIA,KAAOC,WAAuBD,KAI9BE,eAAiB,SAASC,GAC7B,MAAkB,mBAARA,EACFD,eAAgBC,KAEhBA,GAIT,SAASC,WAAWC,EAASC,GAa5BC,cAAcC,IAAIH,EAAS,SAASI,EAAIC,GACvC,IAZ6BC,EAAOC,EAAMC,EAYtCC,EAAUL,EAAGM,aAAa,YAAcN,EAAGM,aAAa,YACxDC,EAAcP,EAAGM,aAAa,OAE9BE,EAAYH,GAAWE,EACvBE,EAASJ,EAAU,UAAY,MAE/BK,EAAWC,WAAWC,MAAM,QAjBhCT,EAAOA,GAAQ,IACfC,EAAQA,GAAS,KAFYF,EAkB2BM,GAd/C,KAAOL,GAAQD,EAAMA,EAAMW,OAAO,KAAOT,EAC1CF,EAAMY,OAAO,EAAGZ,EAAMW,OAAS,GAEhCX,GAW4D,IAAK,CAACa,eAAgB,SAIrFC,GAAkB,EAClBC,EAAgBC,oBAAoBC,OAAO,SAASC,EAAKC,GAC5D,IAAIL,EAAiB,CACpB,IAAIM,EAAOrB,EAAQsB,MAAMC,KAAK,UAAYvB,EAAQsB,MAAMC,KAAK,SACzDF,GAAQA,EAAKG,WACF,QAAXhB,IACFW,EAAMvB,EAAW6B,GAAGN,IAErBE,EAAKG,SAAS5B,EAAW8B,KAAMP,EAAKC,IAGtCL,GAAkB,IAGfY,EAAU,IAAIC,YAAY,WAC7B,IAAIC,EAAO,GACX,GAA4B,iBAAlBpB,EAASoB,KAElBvC,KAAKmB,EAASoB,KAAM,SAASC,EAAKC,GAC7BD,GAAOA,EAAIE,eAAe,OAC7BH,EAAKE,GAAO/B,EAAQsB,MAAMW,KAAKH,EAAII,IAAK,IAAIjC,MAE5C4B,EAAKE,GAAOD,SAGR,GAA4B,mBAAlBrB,EAASoB,KAAoB,CAE7C,IAAIM,EAAU1B,EAASoB,KAAK7B,EAAQsB,MAAOtB,EAAQoC,QAAS,IAC5D9C,KAAK6C,IAAW,SAASL,EAAKC,GAC7BF,EAAKE,GAAOvC,eAAesC,UAG5BD,EAAOpB,EAAS4B,SAASzB,OAASrB,WAAW+C,SAAS7B,EAAS4B,SAAS,GAAGpC,MAAMD,EAAQsB,MAAOtB,EAAQoC,UACrG,GAGJ,IAAIhB,EAAUxB,EAAWY,GAAQqB,GAEjC,OADAb,EAAca,EAAMT,GACbA,IAGRrB,EAAGwC,UAAUC,IAAI,kBAAoBb,EAErC,IAAIc,EAAWC,UAAUC,SAAS,QAAIC,EAAW5C,EAAQ6C,iBAAkB,GAEvEC,EAAO9C,EAAQ+C,YAChB/C,EAAQ+C,YAAa/C,EAAQsB,MAAM0B,IAAIrB,GAAU3B,EAAQoC,QAASK,GAClEQ,SAASC,yBAGZC,cAAcC,YAAYC,KAAKtD,EAAI+C,GAGnCJ,UAAUY,OAAOb,EAAU1C,EAAGwD,YAE9B,IAAIC,EAAkBC,UAAUC,cAAc3D,EAAI,WAC5CA,EAAG4D,cAAcC,SAAS7D,KAC9ByD,IACAd,UAAUmB,WAAWpB,QAMzB,kBAAiBqB,UAAUpE,WAAaA"}