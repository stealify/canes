{"version":3,"file":"can-define-backup.js","sources":["../node_modules/can-define-backup/can-define-backup.js"],"sourcesContent":["\"use strict\";\n//allows you to backup and restore a map instance\nvar canReflect = require('can-reflect');\nvar SimpleObservable = require('can-simple-observable');\nvar diffDeep = require(\"can-diff/deep/deep\");\nvar diffMap = require(\"can-diff/map/map\");\n\nvar flatProps = function (a, cur) {\n\tvar obj = {};\n\tfor (var prop in a) {\n\t\tif (typeof a[prop] !== 'object' || a[prop] === null || a[prop] instanceof Date) {\n\t\t\tobj[prop] = a[prop];\n\t\t} else {\n\t\t\tobj[prop] = cur[prop];//cur.attr(prop);\n\t\t}\n\t}\n\treturn obj;\n};\n\nvar assignNonEnumerable = function(base, props) {\n\tfor(var prop in props) {\n\t\tObject.defineProperty(base, prop, {\n\t\t\tenumerable: false,\n\t\t\tconfigurable: true,\n\t\t\twritable: true,\n\t\t\tvalue: props[prop]\n\t\t});\n\t}\n};\n\nvar observables = new WeakMap();\n\nfunction getBackup(map) {\n\tvar obs = observables.get(map);\n\tif(!obs) {\n\t\tobs = new SimpleObservable();\n\t\tobservables.set(map, obs);\n\t}\n\treturn obs;\n}\n\nfunction defineBackup(Map) {\n\tassignNonEnumerable(Map.prototype, {\n\n\t\tbackup: function () {\n\t\t\tvar store = getBackup(this);\n\t\t\tcanReflect.setValue(store, this.serialize());\n\t\t\treturn this;\n\t\t},\n\n\t\tisDirty: function (checkAssociations) {\n\t\t\tvar store = getBackup(this);\n\t\t\tvar backupStore = canReflect.getValue(store);\n\t\t\tif(!backupStore){\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar currentValue = this.serialize();\n\t\t\tvar patches;\n\t\t\tif(!! checkAssociations) {\n\t\t\t\tpatches = diffDeep(currentValue, backupStore);\n\t\t\t} else {\n\t\t\t\tpatches = diffMap(currentValue, backupStore).filter(function(patch){\n\t\t\t\t\t// only keep those that are not a set of deep object\n\t\t\t\t\tif(patch.type !== \"set\") {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// check values .. if both objects ... we are not dirty ...\n\t\t\t\t\t\tvar curVal = currentValue[patch.key],\n\t\t\t\t\t\t\tbackupVal = backupStore[patch.key];\n\t\t\t\t\t\tvar twoObjectsCompared = curVal && backupVal && typeof curVal === \"object\" && typeof backupVal === \"object\";\n\t\t\t\t\t\treturn !twoObjectsCompared;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn patches.length;\n\t\t},\n\n\t\trestore: function (restoreAssociations) {\n\t\t\tvar store = getBackup(this);\n\t\t\tvar curVal = canReflect.getValue(store);\n\t\t\tvar props = restoreAssociations ? curVal : flatProps(curVal, this);\n\t\t\tif (this.isDirty(restoreAssociations)) {\n\t\t\t\tfor(var prop in props) {\n\t\t\t\t\tthis[prop] = props[prop];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this;\n\t\t}\n\t});\n\n\treturn Map;\n}\n\nmodule.exports = exports = defineBackup;\n"],"names":["flatProps","a","cur","obj","prop","Date","assignNonEnumerable","base","props","Object","defineProperty","enumerable","configurable","writable","value","observables","WeakMap","getBackup","map","obs","get","SimpleObservable","set","module","Map","prototype","backup","store","this","canReflect","setValue","serialize","isDirty","checkAssociations","backupStore","getValue","currentValue","diffDeep","diffMap","filter","patch","type","curVal","key","backupVal","length","restore","restoreAssociations"],"mappings":"87BAOA,IAAIA,EAAY,SAAUC,EAAGC,GAC5B,IAAIC,EAAM,GACV,IAAK,IAAIC,KAAQH,EACO,iBAAZA,EAAEG,IAAkC,OAAZH,EAAEG,IAAkBH,EAAEG,aAAiBC,KACzEF,EAAIC,GAAQH,EAAEG,GAEdD,EAAIC,GAAQF,EAAIE,GAGlB,OAAOD,GAGJG,EAAsB,SAASC,EAAMC,GACxC,IAAI,IAAIJ,KAAQI,EACfC,OAAOC,eAAeH,EAAMH,EAAM,CACjCO,YAAY,EACZC,cAAc,EACdC,UAAU,EACVC,MAAON,EAAMJ,MAKZW,EAAc,IAAIC,QAEtB,SAASC,EAAUC,GAClB,IAAIC,EAAMJ,EAAYK,IAAIF,GAK1B,OAJIC,IACHA,EAAM,IAAIE,iBACVN,EAAYO,IAAIJ,EAAKC,IAEfA,EAuDRI,UApDA,SAAsBC,GAiDrB,OAhDAlB,EAAoBkB,EAAIC,UAAW,CAElCC,OAAQ,WACP,IAAIC,EAAQV,EAAUW,MAEtB,OADAC,WAAWC,SAASH,EAAOC,KAAKG,aACzBH,MAGRI,QAAS,SAAUC,GAClB,IAAIN,EAAQV,EAAUW,MAClBM,EAAcL,WAAWM,SAASR,GACtC,IAAIO,EACH,OAAO,EAER,IAAIE,EAAeR,KAAKG,YAkBxB,OAhBME,EACKI,KAASD,EAAcF,GAEvBI,WAAQF,EAAcF,GAAaK,OAAO,SAASC,GAE5D,GAAkB,QAAfA,EAAMC,KACR,OAAO,EAGP,IAAIC,EAASN,EAAaI,EAAMG,KAC/BC,EAAYV,EAAYM,EAAMG,KAE/B,QADyBD,GAAUE,GAA+B,iBAAXF,GAA4C,iBAAdE,MAKzEC,QAGhBC,QAAS,SAAUC,GAClB,IAAIpB,EAAQV,EAAUW,MAClBc,EAASb,WAAWM,SAASR,GAC7BnB,EAAQuC,EAAsBL,EAAS1C,EAAU0C,EAAQd,MAC7D,GAAIA,KAAKI,QAAQe,GAChB,IAAI,IAAI3C,KAAQI,EACfoB,KAAKxB,GAAQI,EAAMJ,GAGrB,OAAOwB,QAIFJ"}